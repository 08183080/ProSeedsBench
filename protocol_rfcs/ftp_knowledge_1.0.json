{
  "protocol_constants": {
    "delimiters": [
      {
        "value": "<CRLF>",
        "description": "Standard Telnet end-of-line code",
        "source": ""
      },
      {
        "value": "<SP>",
        "description": "Space (ASCII 32), separator between command code and argument",
        "source": ""
      },
      {
        "value": "<d>",
        "description": "RFC 2428 EPRT/EPSV delimiter. Must be ASCII 33-126. Recommended: '|' (ASCII 124)",
        "source": ""
      }
    ],
    "numeric_constraints": [
      {
        "field": "logical_byte_size",
        "min": 0,
        "max": "system_dependent",
        "note": "Transfer byte size is always 8 bits",
        "source": ""
      },
      {
        "field": "PBSZ_buffer_size",
        "max": 4294967295,
        "type": "32-bit unsigned integer",
        "source": ""
      },
      {
        "field": "TCP_Port",
        "min": 0,
        "max": 65535,
        "source": ""
      }
    ]
  },
  "complex_data_types": [
    {
      "name": "rfc959_host_port",
      "bnf": "h1,h2,h3,h4,p1,p2",
      "data_type": "Decimal integers (0-255) separated by commas",
      "constraint": "Concatenation of 32-bit internet host address and 16-bit TCP port",
      "fuzzing_heuristic": "Inject non-numeric chars, values > 255, negative numbers, use '.' instead of ','",
      "source": ""
    },
    {
      "name": "rfc2428_extended_address",
      "bnf": "<d><net-prt><d><net-addr><d><tcp-port><d>",
      "data_type": "String with custom delimiter",
      "constraint": "Delimiter <d> must be same char in all positions. net-prt 1=IPv4, 2=IPv6",
      "fuzzing_heuristic": "Mismatched delimiters, net-prt values > 2, malformed IPv6 strings, delimiter injection (e.g., using a digit as delimiter)",
      "source": ""
    },
    {
      "name": "rfc2228_base64_data",
      "bnf": "<string>",
      "data_type": "Base64 encoded string",
      "constraint": "Line breaks must NOT be included. Must be universally representable [A-Z][a-z][0-9]+/",
      "fuzzing_heuristic": "Insert <CRLF>, use non-base64 chars, overflow buffer size negotiated in PBSZ",
      "source": ""
    }
  ],
  "command_model": [
    {
      "command": "USER",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "Telnet String", "description": "username"}
      ],
      "dependencies": {
        "prerequisites": ["Connection Establishment (220)"],
        "post_conditions": ["State: Expects PASS (331) or Logged In (230)"],
        "reset_behavior": "Reissuing USER flushes prior user/password/account info"
      },
      "logic_traps": [
        "Some servers may require ACCT after PASS"
      ],
      "source": ""
    },
    {
      "command": "PASS",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "Telnet String", "description": "password"}
      ],
      "dependencies": {
        "prerequisites": ["USER"],
        "hard_dependency": "Must be immediately preceded by USER",
        "security_note": "A client should encrypt the PASS command whenever possible (RFC 2228)"
      },
      "source": ""
    },
    {
      "command": "AUTH",
      "rfc_source": "RFC 2228",
      "args_structure": [
        {"type": "String", "description": "mechanism-name (e.g., GSSAPI, KERBEROS_V4)"}
      ],
      "dependencies": {
        "post_conditions": ["State: Security Exchange (Expects ADAT)"],
        "reset_behavior": "Removes any state associated with prior FTP Security commands"
      },
      "fuzzing_heuristic": "Use reserved names starting with 'X-', unsupported mechanism names",
      "source": ""
    },
    {
      "command": "ADAT",
      "rfc_source": "RFC 2228",
      "args_structure": [
        {"type": "rfc2228_base64_data", "description": "security data"}
      ],
      "dependencies": {
        "prerequisites": ["AUTH"],
        "hard_dependency": "Cannot be issued once exchange completes unless reset by AUTH",
        "logic_trap": "Server may return data in 'ADAT=...' text part of reply"
      },
      "source": ""
    },
    {
      "command": "PBSZ",
      "rfc_source": "RFC 2228",
      "args_structure": [
        {"type": "Decimal Integer", "description": "buffer size"}
      ],
      "dependencies": {
        "prerequisites": ["Successful Security Data Exchange (235)"],
        "post_conditions": ["Enables PROT command"],
        "constraint": "Must happen before PROT"
      },
      "fuzzing_heuristic": "Integer overflow (> 2^32), 0, negative values",
      "source": ""
    },
    {
      "command": "PROT",
      "rfc_source": "RFC 2228",
      "args_structure": [
        {"type": "Char", "enum": ["C", "S", "E", "P"], "description": "Protection Level"}
      ],
      "dependencies": {
        "prerequisites": ["PBSZ"],
        "hard_dependency": "Rejected (503) if no previous PBSZ command"
      },
      "source": ""
    },
    {
      "command": "PORT",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "rfc959_host_port", "description": "h1,h2,h3,h4,p1,p2"}
      ],
      "dependencies": {
        "prerequisites": ["Login"],
        "mutual_exclusion": ["PASV", "EPRT", "EPSV"],
        "state_conflict": "Disabled if 'EPSV ALL' was previously issued"
      },
      "logic_traps": [
        "Server usually initiates connection FROM port L-1, but not guaranteed"
      ],
      "source": ""
    },
    {
      "command": "EPRT",
      "rfc_source": "RFC 2428",
      "args_structure": [
        {"type": "rfc2428_extended_address", "description": "|proto|addr|port|"}
      ],
      "dependencies": {
        "mutual_exclusion": ["PORT", "PASV"],
        "state_conflict": "Disabled if 'EPSV ALL' was previously issued"
      },
      "logic_traps": [
        "Delimiter character MUST be one of ASCII 33-126"
      ],
      "source": ""
    },
    {
      "command": "EPSV",
      "rfc_source": "RFC 2428",
      "args_structure": [
        {"type": "Optional String", "enum": ["ALL", "<net-prt>"], "description": "Protocol or ALL"}
      ],
      "dependencies": {
        "side_effect": "If argument is 'ALL', server MUST reject all data setup commands other than EPSV (i.e., EPRT, PORT, PASV)",
        "response_parsing": "Response format is (<d><d><d><tcp-port><d>) - parsing routines must handle this"
      },
      "fuzzing_heuristic": "Send EPSV ALL then attempt PORT/EPRT to check enforcement",
      "source": ""
    },
    {
      "command": "REST",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "Marker String", "description": "Server marker"}
      ],
      "dependencies": {
        "atomic_follower": ["RETR", "STOR", "APPE"],
        "hard_dependency": "Command shall be immediately followed by the appropriate FTP service command"
      },
      "logic_traps": [
        "REST does not cause transfer, it just positions the pointer"
      ],
      "source": ""
    },
    {
      "command": "RNFR",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "Pathname", "description": "Old path"}
      ],
      "dependencies": {
        "atomic_follower": "RNTO",
        "post_conditions": ["State: Pending Rename (350)"]
      },
      "source": ""
    },
    {
      "command": "RNTO",
      "rfc_source": "RFC 959",
      "args_structure": [
        {"type": "Pathname", "description": "New path"}
      ],
      "dependencies": {
        "hard_dependency": "Must be immediately preceded by RNFR"
      },
      "source": ""
    },
    {
      "command": "CCC",
      "rfc_source": "RFC 2228",
      "args_structure": [],
      "dependencies": {
        "prerequisites": ["Successful Security Data Exchange"],
        "constraint": "The CCC command itself MUST be integrity protected (MIC/ENC)",
        "post_conditions": ["Disables integrity protection requirement on control channel"]
      },
      "source": ""
    }
  ],
  "state_machine_matrix": {
    "states": [
      "Not_Logged_In",
      "Logged_In",
      "Intermediate_Auth_Need_Pass",
      "Intermediate_Auth_Need_Account",
      "Intermediate_Rename_Pending",
      "Security_Exchange_In_Progress",
      "Protected_Mode",
      "EPSV_ALL_Mode"
    ],
    "transitions": [
      {
        "trigger": "USER",
        "from": "Not_Logged_In",
        "response_code": "331",
        "to": "Intermediate_Auth_Need_Pass",
        "source": ""
      },
      {
        "trigger": "PASS",
        "from": "Intermediate_Auth_Need_Pass",
        "response_code": "230",
        "to": "Logged_In",
        "source": ""
      },
      {
        "trigger": "PASS",
        "from": "Intermediate_Auth_Need_Pass",
        "response_code": "332",
        "to": "Intermediate_Auth_Need_Account",
        "source": ""
      },
      {
        "trigger": "AUTH",
        "from": "Not_Logged_In",
        "response_code": "334",
        "to": "Security_Exchange_In_Progress",
        "source": ""
      },
      {
        "trigger": "ADAT",
        "from": "Security_Exchange_In_Progress",
        "response_code": "235",
        "to": "Not_Logged_In",
        "note": "Security exchange complete, but USER/PASS still required for Login",
        "source": ""
      },
      {
        "trigger": "EPSV ALL",
        "from": "Logged_In",
        "response_code": "200|229",
        "to": "EPSV_ALL_Mode",
        "note": "Permanent state for session; rejects PORT/EPRT/PASV",
        "source": ""
      },
      {
        "trigger": "RNFR",
        "from": "Logged_In",
        "response_code": "350",
        "to": "Intermediate_Rename_Pending",
        "source": ""
      },
      {
        "trigger": "RNTO",
        "from": "Intermediate_Rename_Pending",
        "response_code": "250",
        "to": "Logged_In",
        "source": ""
      },
      {
        "trigger": "REIN",
        "from": "Any",
        "response_code": "220",
        "to": "Not_Logged_In",
        "note": "Resets all parameters to default",
        "source": ""
      }
    ],
    "error_classes": [
      {
        "code_pattern": "4yz",
        "type": "Transient Negative Completion",
        "action": "Retry allowed, state unchanged",
        "source": ""
      },
      {
        "code_pattern": "5yz",
        "type": "Permanent Negative Completion",
        "action": "Request rejected, state unchanged (typically)",
        "source": ""
      },
      {
        "code_pattern": "533",
        "type": "Security Policy Failure",
        "context": "RFC 2228: Command protection level denied (e.g., sending unprotected command when protected required)",
        "source": ""
      },
      {
        "code_pattern": "522",
        "type": "Extended Port Failure",
        "context": "RFC 2428: Unknown network protocol. Server MUST list supported protocols in text",
        "source": ""
      }
    ]
  }
}
