{
  "meta": {
    "protocol": "SMTP (Simple Mail Transfer Protocol)",
    "rfc_source": "RFC 5321"
  },
  "constants": {
    "transport": "TCP",
    "default_port": 25,
    "delimiters": [
      "<CRLF>",
      "<SP>",
      ":",
      "."
    ],
    "special_tokens": [
      "<",
      ">",
      "@",
      "<CRLF>.<CRLF>"
    ],
    "character_set": "7-bit US-ASCII ",
    "reply_codes_success": ["2xx", "3xx"],
    "reply_codes_transient_failure": ["4xx"],
    "reply_codes_permanent_failure": ["5xx"]
  },
  "syntax_definitions": [
    {
      "name": "Local-part",
      "abnf": "Dot-string / Quoted-string",
      "constraint": "Case-sensitive . Max length 64 octets . MUST NOT contain non-ASCII or control characters .",
      "fuzz_strategy": "Inject high-bit bytes (0x80-0xFF), control chars (0x00-0x1F), or strings > 64 bytes."
    },
    {
      "name": "Domain",
      "abnf": "sub-domain *(\".\" sub-domain)",
      "constraint": "Case-insensitive . Max length 255 octets . Must resolve to MX or A/AAAA record.",
      "fuzz_strategy": "Oversized domain labels (>63 chars), total length > 255, invalid chars (underscore)."
    },
    {
      "name": "Reverse-path",
      "abnf": "Path / \"<>\"",
      "constraint": "Max length 256 octets . Null path \"<>\" used for notifications .",
      "fuzz_strategy": "Length overflow (>256), source routing injection (@host:@host:user), unclosed brackets."
    },
    {
      "name": "Forward-path",
      "abnf": "Path",
      "constraint": "Max length 256 octets . Must be bracketed <...>.",
      "fuzz_strategy": "Length overflow, empty brackets <>, missing domain part."
    },
    {
      "name": "Command-Line",
      "abnf": "Command + Arguments + <CRLF>",
      "constraint": "Max length 512 octets including CRLF .",
      "fuzz_strategy": "Buffer overflow attack with > 512 bytes before CRLF."
    }
  ],
  "message_model": [
    {
      "name": "EHLO",
      "type": "Request",
      "structure": {
        "args": ["Domain | Address-literal"],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Should be the first command in a session .",
          "source_ref": "",
          "violation_heuristic": "Skip EHLO and send MAIL immediately."
        },
        {
          "constraint": "Domain argument required .",
          "source_ref": "",
          "violation_heuristic": "Send EHLO with no arguments."
        }
      ]
    },
    {
      "name": "MAIL",
      "type": "Request",
      "structure": {
        "args": ["FROM:<Reverse-path>", "Optional-Parameters"],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "No spaces allowed between MAIL and FROM:, or FROM and : .",
          "source_ref": "",
          "violation_heuristic": "Inject spaces: 'MAIL FROM : <...>'."
        },
        {
          "constraint": "Resets state tables and buffers (Sender, Recipients, Data) .",
          "source_ref": "",
          "violation_heuristic": "Send multiple MAIL commands in sequence without RSET."
        }
      ]
    },
    {
      "name": "RCPT",
      "type": "Request",
      "structure": {
        "args": ["TO:<Forward-path>", "Optional-Parameters"],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Must be preceded by a successful MAIL command .",
          "source_ref": "",
          "violation_heuristic": "Send RCPT before MAIL."
        },
        {
          "constraint": "Server must support at least 100 recipients .",
          "source_ref": "",
          "violation_heuristic": "Send 101+ RCPT commands to trigger buffer exhaustion logic."
        },
        {
          "constraint": "Postmaster mailbox must be accepted case-insensitively without domain .",
          "source_ref": "",
          "violation_heuristic": "Test RCPT TO:<POSTMASTER> vs RCPT TO:<postmaster@domain>."
        }
      ]
    },
    {
      "name": "DATA",
      "type": "Request",
      "structure": {
        "args": [],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Must be preceded by valid MAIL and at least one valid RCPT .",
          "source_ref": "",
          "violation_heuristic": "Send DATA immediately after connection."
        },
        {
          "constraint": "Wait for 354 Intermediate reply before sending body .",
          "source_ref": "",
          "violation_heuristic": "Pipeline message body immediately after DATA command without waiting for 354."
        },
        {
          "constraint": "End of data indicated by <CRLF>.<CRLF> .",
          "source_ref": "",
          "violation_heuristic": "Send bare <LF>.<LF> or omit termination sequence."
        }
      ]
    },
    {
      "name": "RSET",
      "type": "Request",
      "structure": {
        "args": [],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Discards stored sender, recipients, and mail data; clears buffers .",
          "source_ref": "",
          "violation_heuristic": "Send RSET, then try to DATA without re-issuing MAIL/RCPT."
        }
      ]
    },
    {
      "name": "VRFY",
      "type": "Request",
      "structure": {
        "args": ["String (User/Mailbox)"],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Ambiguous results may return 553 code .",
          "source_ref": "",
          "violation_heuristic": "Fuzz with wildcards or common list names."
        }
      ]
    },
    {
      "name": "QUIT",
      "type": "Request",
      "structure": {
        "args": [],
        "terminator": "<CRLF>"
      },
      "semantic_rules": [
        {
          "constraint": "Server must send 221 OK then close connection .",
          "source_ref": "",
          "violation_heuristic": "Pipeline commands after QUIT."
        }
      ]
    }
  ],
  "state_machine": {
    "states": [
      "CONNECTED_WAITING_GREETING",
      "INIT (No State)",
      "READY (Session Active)",
      "MAIL_TRANSACTION_STARTED",
      "RECIPIENTS_ADDED",
      "DATA_TRANSFER_MODE",
      "QUIT_PENDING"
    ],
    "transitions": [
      {
        "from": "CONNECTED_WAITING_GREETING",
        "trigger": "Server Banner",
        "condition": "220 Service Ready",
        "to": "INIT (No State)",
        "source_ref": ""
      },
      {
        "from": "INIT (No State)",
        "trigger": "EHLO / HELO",
        "condition": "250 OK",
        "to": "READY (Session Active)",
        "source_ref": ""
      },
      {
        "from": "READY (Session Active)",
        "trigger": "MAIL",
        "condition": "250 OK",
        "to": "MAIL_TRANSACTION_STARTED",
        "source_ref": ""
      },
      {
        "from": "MAIL_TRANSACTION_STARTED",
        "trigger": "RCPT",
        "condition": "250 OK",
        "to": "RECIPIENTS_ADDED",
        "source_ref": ""
      },
      {
        "from": "RECIPIENTS_ADDED",
        "trigger": "RCPT",
        "condition": "250 OK",
        "to": "RECIPIENTS_ADDED",
        "source_ref": ""
      },
      {
        "from": "RECIPIENTS_ADDED",
        "trigger": "DATA",
        "condition": "354 Start mail input",
        "to": "DATA_TRANSFER_MODE",
        "source_ref": ""
      },
      {
        "from": "DATA_TRANSFER_MODE",
        "trigger": "<CRLF>.<CRLF>",
        "condition": "250 OK",
        "to": "READY (Session Active)",
        "source_ref": ""
      },
      {
        "from": "ANY",
        "trigger": "RSET",
        "condition": "250 OK",
        "to": "READY (Session Active)",
        "source_ref": ""
      },
      {
        "from": "ANY",
        "trigger": "QUIT",
        "condition": "221 OK",
        "to": "CLOSED",
        "source_ref": ""
      }
    ]
  }
}
